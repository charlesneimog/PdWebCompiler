#ifndef PD4WEB_HPP

#define PD4WEB_HPP

#include <emscripten.h>
#include <emscripten/bind.h>
#include <emscripten/webaudio.h>

#include <util/z_print_util.h>
#include <z_libpd.h>

#define PD4WEB_MAJOR_VERSION 2
#define PD4WEB_MINOR_VERSION 0
#define PD4WEB_MICRO_VERSION 0

#define PD4WEB_DEBUG false

#if not defined(N_CH_IN) || not defined(N_CH_OUT) || not defined(SAMPLE_RATE)
#define N_CH_IN 1         // default, this is defined by pd4web python module
#define N_CH_OUT 2        // default, this is defined by pd4web python module
#define SAMPLE_RATE 48000 // default, this is defined by pd4web python module
#endif

void Pd4WebInitExternals(); // defined in externals.cpp (generated by pd4web.py)

static uint8_t wasmAudioWorkletStack[1024 * 1024];

// ╭─────────────────────────────────────╮
// │             Main Class              │
// ╰─────────────────────────────────────╯

class Pd4Web {
  public:
    static void AudioWorkletProcessorCreated(EMSCRIPTEN_WEBAUDIO_T audioContext, EM_BOOL success,
                                             void *userData);

    EMSCRIPTEN_KEEPALIVE void Init();
    void SuspendAudio();
    void ResumeAudio();

    // bind symbols
    void BindReceiver(std::string s);
    void UnbindReceiver();

    // send Messages
    bool SendFloat(std::string r, float f);
    bool SendSymbol(std::string r, std::string s);

    bool _startMessage(int argc);
    void _addFloat(float f);
    void _addSymbol(std::string s);
    void _finishMessage(std::string s);

    // libpd HOOKs
    void receiveMessage(const char *source, const char *symbol, int argc, t_atom *argv);

  private:
    static int GetNInputChannels();
    static int GetNOutputChannels();
    static uint32_t GetSampleRate();

    // bind list

    bool Pd4WebInit = false;
    EMSCRIPTEN_WEBAUDIO_T Context;
    bool pdInit = false;
};

// ╭─────────────────────────────────────╮
// │  Bind C++ functions to JavaScript   │
// ╰─────────────────────────────────────╯
EMSCRIPTEN_BINDINGS(WebPd) {
    emscripten::class_<Pd4Web>("Pd4Web")
        .constructor<>() // Default constructor
        .function("init", &Pd4Web::Init)
        .function("suspendAudio", &Pd4Web::SuspendAudio)
        .function("resumeAudio", &Pd4Web::ResumeAudio)

        // senders
        .function("sendFloat", &Pd4Web::SendFloat)
        .function("sendSymbol", &Pd4Web::SendSymbol)

        // sendList is added by _Pd4WebJSFunctions();
        .function("_startMessage", &Pd4Web::_startMessage)
        .function("_addFloat", &Pd4Web::_addFloat)
        .function("_addSymbol", &Pd4Web::_addSymbol)
        .function("_finishMessage", &Pd4Web::_finishMessage)

        // bind list
        .function("bindReceiver", &Pd4Web::BindReceiver)
        .function("unbindReceiver", &Pd4Web::UnbindReceiver);
}

#endif // PD4WEB_HPP
